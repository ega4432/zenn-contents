---
title: "Composer ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã«å­¦ã¶ Dockerfile FROM å‘½ä»¤ã®ã‚¿ã‚°æŒ‡å®š"
emoji: "ğŸ—‚"
type: "tech"
topics: ["docker"]
published: true
---
# ã¯ã˜ã‚ã«

ã‚ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ Laravel ç’°å¢ƒã‚’ Docker ã§æ§‹ç¯‰ã—ã¦é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚ãã®ä¸­ã§ã€å€‹äººçš„ã«ã¡ã‚‡ã£ã¨ã—ãŸå­¦ã³ãŒã‚ã£ãŸã®ã§ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

```sh
âœ docker -v
Docker version 20.10.5, build 55c4c88
```

# é–‹ç™ºç’°å¢ƒã®ã‚³ãƒ³ãƒ†ãƒŠ

ä¸‹è¨˜ãŒãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã® Dockerfile ã§ã™ã€‚

```Dockerfile
FROM php:7.4-fpm-alpine

COPY php.ini /usr/local/etc/php/

ARG TZ

COPY --from=composer /usr/bin/composer /usr/bin/composer
ENV COMPOSER_ALLOW_SUPERUSER 1
ENV COMPOSER_HOME /composer
RUN composer config -g repos.packagist composer https://packagist.jp
RUN composer global require hirak/prestissimo
RUN docker-php-ext-install pdo_mysql opcache
```

## Dockerfile ã®è©³ç´°

### ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰

åå‰ã®é€šã‚Šã€è¤‡æ•°ã®ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã«åˆ†å‰²ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã„ã¾ã™ã€‚ã“ã®æ‰‹æ³•ã‚’ç”¨ã„ã‚‹ã“ã¨ã®ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã¯ã€**ãƒ“ãƒ«ãƒ‰ç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¨ã—ã¦å‹•ãã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ†é›¢ã§ãã‚‹ã“ã¨**ã€**ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®è»½é‡åŒ–**ãªã©ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

ã“ã¡ã‚‰ã® Dockerfile ã§ã¯ã€å…¬å¼ã® Composer ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

```Dockerfile
COPY --from=composer /usr/bin/composer /usr/bin/composer
```

ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã«ã¤ã„ã¦è©³ã—ãè¨€åŠã—ãªã„ã®ã§ã€çŸ¥ã‚‰ãªã‹ã£ãŸã¨ã„ã†æ–¹ã¯æ˜¯éä¸‹è¨˜ã®è¨˜äº‹ã‚’ã”ä¸€èª­ãã ã•ã„ã€‚

https://qiita.com/minamijoyo/items/711704e85b45ff5d6405

### hirak/prestissimo

ç¶šã„ã¦å°å…¥ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ã§ã™ã€‚
ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€composer ã§ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ä¸¦åˆ—ã§è¡Œã£ã¦ãã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚ãã‚Œã«ã‚ˆã‚Šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®é«˜é€ŸåŒ–ãŒç‹™ãˆã‚‹ã®ã§ã€æ¯å›å…¥ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

# ä»Šå›ã®å•é¡Œ

ä¸Šè¨˜ã® Dockerfile ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚

```sh
âœ docker build --no-cache .

..

 => ERROR [stage-0 5/6] RUN composer global require hirak/prestissimo                                                             1.2s
------
 > [stage-0 5/6] RUN composer global require hirak/prestissimo:
#9 0.300 Changed current directory to /composer
#9 1.195
#9 1.199
#9 1.199   [RuntimeException]

#9 1.199   No composer.json present in the current directory (./composer.json), this may be the cause of the following exception.
#9 1.199
#9 1.199
#9 1.201
#9 1.201   [InvalidArgumentException]
#9 1.201   Could not find package hirak/prestissimo.
#9 1.201
#9 1.201   Did you mean this?
#9 1.201       hirak/prestissimo
#9 1.201
#9 1.201
#9 1.201 require [--dev] [--dry-run] [--prefer-source] [--prefer-dist] [--fixed] [--no-suggest] [--no-progress] [--no-update] [--no-install] [--no-scripts] [--update-no-dev] [-w|--update-with-dependencies] [-W|--update-with-all-dependencies] [--with-dependencies] [--with-all-dependencies] [--ignore-platform-req IGNORE-PLATFORM-REQ] [--ignore-platform-reqs] [--prefer-stable] [--prefer-lowest] [--sort-packages] [-o|--optimize-autoloader] [-a|--classmap-authoritative] [--apcu-autoloader] [--apcu-autoloader-prefix APCU-AUTOLOADER-PREFIX] [--] [<packages>]...
#9 1.201
------
executor failed running [/bin/sh -c composer global require hirak/prestissimo]: exit code: 1
```

# åŸå› 

## ã‚¿ã‚°ã®æŒ‡å®š

ã±ã£ã¨è¦‹ã€å‰è¿°ã—ãŸ `hirak/prestissimo` ãŒãªã„è¦‹ã¤ã‹ã‚‰ãªã„ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

å™›ã¿ç •ã„ã¦ã„ãã¨ `--from=composer` ã§ã¯ã€ã‚¿ã‚°ã«ã‚ˆã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šã‚’è¡Œãªã£ã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ `latest` ã¨ã„ã†ã‚¿ã‚°ãŒ Docker Hub ã‚ˆã‚Š pull ã•ã‚Œã‚‹ãŸã‚ã€ä»Šå› `composer:latest` ã™ãªã‚ã¡ 2 ç³»ã®å…¬å¼ composer ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒ docker pull ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ï¼ˆPHP ã§ã¯æŒ‡å®šã—ã¦ã„ã‚‹ã®ã«ãƒ»ãƒ»ãƒ»ã€‚ï¼‰

## Composer v2

composer 2 ç³»ã§ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§åŠ‡çš„ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚ã“ã“ã§ã‚‚è©³ç´°ã¯å‰²æ„›ã—ã¾ã™ã€‚ä¸‹è¨˜ã®è¨˜äº‹ã«åˆ†ã‹ã‚Šã‚„ã™ãã¾ã¨ã‚ã¦ã‚ã‚Šã¾ã—ãŸã€‚

https://qiita.com/ucan-lab/items/289009ffe5bb417c808e

ã“ã“ã§ã®ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ã€composer v2 ã§ã¯ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä¸¦åˆ—ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚ã™ãªã‚ã¡ `hirak/prestissimo` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã—ãŸã€‚

https://github.com/composer/composer/pull/5293/files

# å¯¾å‡¦å†…å®¹

å¯¾å‡¦ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã¯ 2 ã¤è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

## 1. composer v2 ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰

å˜ç´”ã« composer v2 ã«ã—ã¦ã—ã¾ã†ã¨ã„ã†æ–¹æ³•ã§ã™ã€‚ãã®å ´åˆã¯ Dockerfile ã§ `hirak/prestissimo` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ç®‡æ‰€ã‚’å‰Šé™¤ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

ã¾ãŸã€ä»Šå¾Œã®ã“ã¨ã‚‚è€ƒãˆã‚‹ã¨ã‚¿ã‚°ã‚‚æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ã‚ã’ã¦ãŠãã®ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚

```diff Dockerfile
FROM php:7.4-fpm-alpine

COPY php.ini /usr/local/etc/php/

ARG TZ

- COPY --from=composer /usr/bin/composer /usr/bin/composer
+ COPY --from=composer:2.0 /usr/bin/composer /usr/bin/composer
ENV COMPOSER_ALLOW_SUPERUSER 1
ENV COMPOSER_HOME /composer
RUN composer config -g repos.packagist composer https://packagist.jp
- RUN composer global require hirak/prestissimo
RUN docker-php-ext-install pdo_mysql opcache
```

## 2. Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚¿ã‚°ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š

composer v2 ã«æ°—è»½ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã—ã¾ã†ã®ãŒã€æ€–ã„å ´åˆã¯ä¸Šè¨˜ã®ã†ã¡å¾Œè€…ã ã‘è¡Œã†ã¨ã„ã†æ–¹æ³•ã§ã™ã€‚ã‚‚ã—ã‹ã—ãŸã‚‰ä¾å­˜é–¢ä¿‚ã«ã‚ˆã‚Šå‹•ã‹ãªããªã£ã¦ã—ã¾ã†å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚ãã®éš›ã¯ 1 ç³»ã§å›ºå®šã—ã¦ã—ã¾ã†ã®ã‚‚å¿œæ€¥å‡¦ç½®ã¨ã—ã¦ã¯ã‚ã‚Šã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

```Dockerfile
COPY --from=composer:1.10 /usr/bin/composer /usr/bin/composer
```

# ã¾ã¨ã‚

æœ€å¾Œã«æœ¬è¨˜äº‹ã®ã¾ã¨ã‚ã‚’æ›¸ã„ã¦çµ‚ã‚ã‚Šã¾ã™ã€‚

- Dockerfile ã® FROM å‘½ä»¤ã§ã¯ã‚¿ã‚°ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ã®ã‚’å¿˜ã‚Œãªã„ã€‚
- composer ã¯ 2 ç³»ã‚’ç©æ¥µçš„ã«å°å…¥ã—ã¦ã„ããŸã„ã€‚
- `hirak/prestissimo` ã¯ã¨ã¦ã‚‚å„ªç§€ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚1 ç³»ã‚’ä½¿ã†ãªã‚‰å°å…¥å¿…é ˆã€‚

# å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸã‚µã‚¤ãƒˆ

https://qiita.com/lighthawk/items/dc9ba08206b02ffca8a0
https://docs.docker.jp/engine/userguide/eng-image/dockerfile_best-practice.html
