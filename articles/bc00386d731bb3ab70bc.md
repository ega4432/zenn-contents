---
title: "AWS ç’°å¢ƒã® SPA ã§å‹•çš„ OGP ã‚’å®Ÿç¾ã™ã‚‹"
emoji: "ğŸ’¬"
type: "tech"
topics: ["aws", "spa", "lambda", "cloudfront", "ogp"]
published: true
---
# ã¯ã˜ã‚ã«

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒ SPA ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ OGP å¯¾å¿œã—ãŸéš›ã«ã€å‰²ã¨å¤§å¤‰ã ã£ãŸã®ã§å‚™å¿˜éŒ²ã¨ã—ã¦ã¾ã¨ã‚ã¾ã™ã€‚çµè«–ã‹ã‚‰è¨€ã†ã¨ã€Lambda@Edge ã‚’ä½¿ã£ã¦ User-Agent ã§ bot ã‹ã©ã†ã‹åˆ¤æ–­ã—ã€HTML ã‚’è¿”ã™ã¨ã„ã†ãŠæ±ºã¾ã‚Šã®æ‰‹æ³•ã§è¡Œã„ã¾ã—ãŸã€‚

ãã®ä¸­ã§ã‚‚ã€ä»Šå›ã¯ REST API ã‹ã‚‰ç”»åƒ URL ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§ Lambda@Edge å†…ã§ API ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å‡¦ç†ã‚‚å®Ÿè£…ã—ã¾ã—ãŸã€‚

# å‰æ

ä»Šå›ã¯ã€AWS ç’°å¢ƒä¸Šã§ S3 + CloudFront ã«ã‚ˆã£ã¦æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/eyvj7rkv751qkrm3pf8ys4latmrw)

:::message
ä»Šå›ã¯ S3, CloudFront ã¯ä½œæˆã•ã‚Œã¦ã„ã‚‹å‰æã§è¡Œã£ã¦ã„ãã¾ã™ã€‚
:::

**SPA(ã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³)** ã§ã¯ã€å˜ä¸€ã® Web ãƒšãƒ¼ã‚¸ãŒã‚ãŸã‹ã‚‚ãƒšãƒ¼ã‚¸é·ç§»ã™ã‚‹ã‹ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆãŒè¡Œã‚ã‚Œã¾ã™ã€‚ãã‚Œã‚‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ JavaScript ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚

ã—ã‹ã—ã€SNS ãªã©ã§ã‚·ã‚§ã‚¢ã•ã‚ŒãŸéš›ã« OGP ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã¯ã€ä¸€æ‰‹é–“å¿…è¦ã§ã™ã€‚ãªãœãªã‚‰ URL ã‚’æŠ•ç¨¿ã•ã‚ŒãŸéš›ã«ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ Twitter ã‚„ Facebook ãªã©ã®å„ã‚¯ãƒ­ãƒ¼ãƒ©ã¯ JavaScript ã‚’è§£é‡ˆã—ãªã„ãŸã‚ä»Šå›ã®ä¾‹ã«æŒ™ã’ãŸã‚ˆã†ãª SPA ã§ã¯å‹•çš„ã« OGP ã‚’è¿”ã™ã“ã¨ãŒã§ããªã„ã‹ã‚‰ã§ã™ã€‚

# æ–¹é‡

çµè«–ã‹ã‚‰è¨€ã†ã¨ã€[Lambda@Edge](https://aws.amazon.com/jp/lambda/edge/) ã¨ã„ã† CloudFront ã®æ©Ÿèƒ½ã‚’ä½¿ã„å‹•çš„ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã®æœ€å¾Œã«æ²è¼‰ã•ã›ã¦ã„ãŸã ã„ã¦ã„ã‚‹è¨˜äº‹ã«ã‚‚æ›¸ã„ã¦ã„ã‚‰ã£ã—ã‚ƒã‚‹æ–¹ã‚‚å¤šãã€å‰ä¾‹ãŒãŸãã•ã‚“ã‚ã‚‹ã®ã§å®‰å¿ƒã—ã¦å®Ÿè£…ã§ãã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/ba8046690c12075dc6361a3b.png)
*User-Agent ãŒ bot ã®å ´åˆã¯ã€Lambda@Edge ã§å‹•çš„ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™*

# å®Ÿè£…

## Lambda é–¢æ•°ã‚’ä½œæˆã™ã‚‹

ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ãã€ä¸‹è¨˜ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ã‚ˆã†ã« Lambda é–¢æ•°ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚ä¸‹è¨˜ã®ã‚ˆã†ã«é–¢æ•°åã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã€ãƒ­ãƒ¼ãƒ«ãªã©ã®ä»»æ„ã®ã‚‚ã®ã‚’æŒ‡å®šã—ã¾ã™ã€‚

å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«ã¯ `AWSLambdaBasicExecutionRole` ã¨ã„ã† IAM ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã—ãŸ IAM ãƒ­ãƒ¼ãƒ«ã‚’äº‹å‰ã«ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/fcc0759d5f1597c84f2dce81.png)

:::message alert
Lambda@Edge ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ Lambda é–¢æ•°ã¯ US-East-1ï¼ˆãƒãƒ¼ã‚¸ãƒ‹ã‚¢åŒ—éƒ¨ï¼‰ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
:::

ç¶šã„ã¦å®Ÿéš›ã® Lambda ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ä¸Šè¨˜ã§ Node.js ã‚’ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¨ã—ã¦æŒ‡å®šã—ãŸãŸã‚ JavaScript ã§æ›¸ã„ã¦ã„ãã¾ã™ã€‚

```js:index.js
'use strict';
const DOMAIN = 'example.com';
const SERVICE_NAME = 'ã‚µãƒ¼ãƒ“ã‚¹å';
const DESCRIPTION = 'ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³';

// OGP ã‚’è¿”ã—ãŸã„ User-Agent ã‚’ãƒªã‚¹ãƒˆã§å®šç¾©ã—ã¦ãŠãã€‚
const bots = [
    'Twitterbot',
    'facebookexternalhit',
    'Slackbot-LinkExpanding'
];

exports.handler = async (event, context, callback) => {
    const request = event.Records[0].cf.request;
    const userAgent = request.headers['user-agent'][0].value;
    const isBotAccess = bots.some((bot) => userAgent.includes(bot));

    // Create OGP response
    if (isBotAccess) {
        // ğŸŒŸ Do something
        const botResponse = {
            status: 200,
            headers: {
                'content-type': [{
                    key: 'Content-Type',
                    value: 'text/html; charset=UTF-8',
                }],
            },
            body: getHTML('', '', DOMAIN + request.uri)
        };
        callback(null, botResponse);
        return;
    }
    callback(null, request);
};

const getHTML = (title, ogImage, url) => {
  return `
<!doctype html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>${title}ï½œ${SERVICE_NAME}</title>
  <meta name="description" content="${DESCRIPTION}" />
  <meta property="og:url" content="https://${url}" />
  <meta property="og:type" content="article" />
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:title" content="${title}ï½œ${SERVICE_NAME}" />
  <meta property="og:description" content="${DESCRIPTION}" />
  <meta property="og:image" content="${ogImage}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@Twitter"  />
  <meta name="twitter:title" content="${title}ï½œ${SERVICE_NAME}" />
  <meta name="twitter:description" content="${DESCRIPTION}" />
  <meta name="twitter:image" content="${ogImage}" />
</head>
<body></body>
</html>
`;
};
```

å¤§æ ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚
ã“ã‚Œã«ãƒ—ãƒ©ã‚¹ã—ã¦ã€REST API ã‹ã‚‰ç”»åƒ URL å–å¾—ã™ã‚‹å‡¦ç†ã‚’æŒŸã‚“ã§ `getHTML()` ã®å¼•æ•°ã«æ¸¡ã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Lambda@Edge ã§å¤–éƒ¨ API ã‚’å©ã

API ã‚’å©ãå‡¦ç†ã‚’è¿½è¨˜ã—ã¦ã„ãã¾ã™ã€‚

ä»Šå›ã¯ã€[ethanent/phin](https://github.com/ethanent/phin) ã¨ã„ã† JS è£½ã® HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚ç†ç”±ã¨ã—ã¦ã¯ã€[axios](https://github.com/axios/axios) ã‚„ [request](https://github.com/request/request) ã¨ã„ã£ãŸæ¯”è¼ƒçš„ãƒ¡ã‚¸ãƒ£ãƒ¼ãªã‚‚ã®ã‚ˆã‚Šã‚‚è»½é‡ã ã£ãŸã‹ã‚‰ã§ã™ã€‚

```diff js:index.js
'use strict';
+ const p = require('phin');
const DOMAIN = 'example.com';
const SERVICE_NAME = 'ã‚µãƒ¼ãƒ“ã‚¹å';
const DESCRIPTION = 'ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³';

// OGP ã‚’è¿”ã—ãŸã„ User-Agent ã‚’ãƒªã‚¹ãƒˆã§å®šç¾©ã—ã¦ãŠãã€‚
const bots = [
    'Twitterbot',
    'facebookexternalhit',
    'Slackbot-LinkExpanding'
];

exports.handler = async (event, context, callback) => {
    const request = event.Records[0].cf.request;
    const userAgent = request.headers['user-agent'][0].value;
    const isBotAccess = bots.some((bot) => userAgent.includes(bot));
+    const urlPaths = request.uri.split('/').slice(-2);

    // Create OGP response
+   // ãƒªã‚¯ã‚¨ã‚¹ãƒˆ URL ãŒ "https://example.com/posts/:id" ã ã£ãŸå ´åˆã®æ¡ä»¶ã‚’è¿½åŠ 
+   if (isBotAccess && urlPaths[0] == 'posts' && !isNaN(urlPaths[1])) {
-   if (isBotAccess) {
-       // ğŸŒŸ Do something
+       const res = await p({ 'url': `https://api.example.com/posts/${urlPaths[1]}`, 'parse': 'json' });
        const botResponse = {
            status: 200,
            headers: [{ 'Content-Type': 'text/html' }],
-           body: getHTML('', '', DOMAIN + request.uri)
+           body: getHTML(res.body.title, res.body.image_url, DOMAIN + request.uri)
        };
        callback(null, botResponse);
        return;
    }
    callback(null, request);
};

const getHTML = (title, ogImage, url) => {
  // çœç•¥
};
```

:::message alert
Lambda é–¢æ•°ãŠã‚ˆã³çµ„ã¿è¾¼ã¿ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æœ€å¤§åœ§ç¸®ã‚µã‚¤ã‚ºã¯ã€ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã¯ 1MB ã¾ã§ã¨ãªã£ã¦ã„ã¾ã™ã€‚Lambda@Edge ã¯ä»–ã«ã‚‚ä½•ã‹ã¨åˆ¶é™ãŒå¤šã„ã®ã§äº‹å‰ã«ç¢ºèªã™ã‚‹ã¨ãƒãƒã‚‰ãšæ¸ˆã‚€ãŸã‚ãŠã™ã™ã‚ã§ã™ã€‚
https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/cloudfront-limits.html#limits-lambda-at-edge
:::

## ã‚³ãƒ¼ãƒ‰ã‚’ .zip ã«åœ§ç¸®ã™ã‚‹

æœ€å¾Œã« `index.js` ã¨ `node_modules/` ã‚’ .zip ã«åœ§ç¸®ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```sh
$ tree
.
â”œâ”€â”€ index.js
â”œâ”€â”€ node_modules/
â””â”€â”€ package.json

$ zip -r ../ogp-response-sample.zip .
```

# CloudFront ã®è¨­å®šã‚’å¤‰æ›´ã™ã‚‹

ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚ˆã‚Šã€ã‚¢ã‚¿ãƒƒãƒã—ãŸã„ CloudFront ã® Distribution ã‚’é–‹ã„ã¦ Behavior ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦ç·¨é›†ç”»é¢ã‚’é–‹ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/1bb20f67871e682cb9ae3c06.png)

Edge Function Association ã®é …ç›®ã«ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã¯ `Viewer-Request` ã‚’ã€Function ARN ã¯å…ˆã»ã©ä½œæˆã—ãŸ Lambda é–¢æ•°ã® ARN ã‚’ `ARN:${VERSION}` å½¢å¼ã§å…¥åŠ›ã—ã¾ã™ã€‚

# ç¢ºèª

OGP ãŒæ­£ã—ãåæ˜ ã•ã‚ŒãŸã‹ã®å‹•ä½œç¢ºèªã¯ä¸‹è¨˜ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã„ã¾ã—ãŸã€‚

- [Card Validator \| Twitter Developers](https://cards-dev.twitter.com/validator)
- [ã‚·ã‚§ã‚¢ãƒ‡ãƒãƒƒã‚¬ãƒ¼ \- Facebook for Developers](https://developers.facebook.com/tools/debug/)

# ã¾ã¨ã‚

SPA ãªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒã« OGP å¯¾å¿œã‚’ã—ã¾ã—ãŸã€‚æœ€å¾Œã«ç°¡å˜ã«ãƒã‚¤ãƒ³ãƒˆã ã‘ã¾ã¨ã‚ã¾ã™ã€‚

- CloudFront ã®æ©Ÿèƒ½ **Lambda@Edge** ã‚’ä½¿ã†ã¨ã€SPA ã§ã‚‚å‹•çš„ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ãŒã§ãã‚‹ã€‚
  - REST API ã‚’å©ãã“ã¨ã‚‚ã§ãã‚‹ã€‚
- Lambda@Edge ã¯åˆ¶é™ãŒå¤šã„ã®ã§äº‹å‰ã«ç¢ºèªã—ã‚ˆã†ã€‚
- å‹•ä½œç¢ºèªãŒã¡ã‚‡ã£ã¨é¢å€’ãªã®ã§ã€ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

ã“ã“ã¾ã§èª­ã‚“ã§ãã ã•ã‚Šã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ä»–ã«ã‚‚ã€Œã“ã†ã„ã£ãŸæ–¹æ³•ãŒã‚ã‚‹ã‚ˆã€ã€Œã“ã£ã¡ãŒæ¥½ã«ã§ãã‚‹ã‚ˆã€ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™:pray:

# å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸã‚µã‚¤ãƒˆ

https://dev.classmethod.jp/articles/lambda-edge-ogp/
https://qiita.com/kurimoto/items/6212372ead6522161a60
https://qiita.com/geerpm/items/78e2b85dca3cb698e98d
https://aws.amazon.com/jp/lambda/edge/
https://github.com/ethanent/phin
https://romiogaku.hateblo.jp/entry/2018/12/19/113111
