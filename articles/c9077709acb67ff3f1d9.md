---
title: "Kindle ã§è³¼å…¥ã—ãŸæ›¸ç±ã‚’ãƒ–ã‚¯ãƒ­ã‚°ã¸è‡ªå‹•ã§ç™»éŒ²ã™ã‚‹"
emoji: "ğŸ·"
type: "tech"
topics: ["googleappsscrip", "clasp", "typescript", "githubactions", "kindle"]
published: true
---

# ã¯ã˜ã‚ã«

ã„ããªã‚Šã§ã™ãŒã€ã¿ãªã•ã‚“èª­æ›¸ã®ç®¡ç†ã£ã¦ã©ã†ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ

åƒ•ã¯ã€[ãƒ–ã‚¯ãƒ­ã‚°](https://booklog.jp/) ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚ä»¥å‰ã¯ã€[èª­æ›¸ãƒ¡ãƒ¼ã‚¿ãƒ¼](https://bookmeter.com/) ã‚’ä½¿ã£ã¦ã„ãŸã‚“ã§ã™ãŒã€ãƒ–ã‚¯ãƒ­ã‚°ã¯æœ¬ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ ISBN ã‚³ãƒ¼ãƒ‰ã‚„ Amazon ã® Asin ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æœ¬ã‚’ç™»éŒ²ã§ãã‚‹[^1]ã¨ã„ã†ã“ã¨ã‚’çŸ¥ã£ã¦æœ€è¿‘ç§»è¡Œã—ã¾ã—ãŸã€‚

ã©ã†ã›ãªã‚‰è‡ªå‹•åŒ–ã—ãŸã„ãªã¨æ€ã„ã€èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚ã™ã‚‹ã¨åŒã˜ã“ã¨ã‚’è€ƒãˆãŸå…ˆäººãŸã¡ãŒã„ã‚‰ã£ã—ã‚ƒã£ãŸã®ã§å‚è€ƒã«ã—ã¤ã¤ã‚„ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚å½“è¨˜äº‹ã¯ãã®ç´¹ä»‹ã§ã™ã€‚

# ä½œã£ãŸã‚‚ã®

Kindle ã§æ›¸ç±ã‚’è³¼å…¥ã—ãŸéš›ã« Amazon ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã¾ã™ã€‚ãã®ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ä½¿ã„ãŸã„ Asin ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’æŠœãå‡ºã—ã¦ã€è³¼å…¥ã—ãŸæ›¸ç±ã‚’ãƒ–ã‚¯ãƒ­ã‚°ã«ç™»éŒ²ã—ã¾ã™ã€‚ãã®éš›ã€å‡¦ç†ã®ãƒ­ã‚°ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ç™»éŒ²ã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®å‡¦ç†ã¯ã€TypeScript ã§æ›¸ã„ã¦ã„ã¦ GitHub ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ GitHub Actions ã‚’ä½¿ã£ã¦ Google Apps Script ã¸è‡ªå‹•ã§è¡Œã„ã€Google Apps Script ã®ãƒˆãƒªã‚¬ãƒ¼ã§å®šæœŸå®Ÿè¡Œã•ã›ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8ab2d93ed929a9b49f25edd6.png)
*ä½œã£ãŸã‚‚ã®ã®å…¨ä½“åƒ*

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

https://github.com/ega4432/kindle-booklog-sync

# ä½œæˆæ‰‹é †

ä»¥ä¸‹ãƒã‚¤ãƒ³ãƒˆã ã‘ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

## ãƒ­ãƒ¼ã‚«ãƒ«ã§ Google Apps Script ã‚’ä½¿ã†

Amazon ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã—ã¦ç™»éŒ²ã—ã¦ã„ã‚‹ã®ãŒ Gmail ãªã®ã§ã€ãã‚Œã‚’æ‰±ã„ã‚„ã™ã„ Google Apps Script ( ä»¥ä¸‹ GAS ) ãŒé¸æŠè‚¢ã¨ã—ã¦æŒ™ã’ã‚‰ã‚Œã¾ã—ãŸã€‚

ã¾ãŸã€Clasp ã‚’ä½¿ã†ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã§ GAS ã‚’æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã¯ä¸‹è¨˜ã§ã™ã€‚

- ã‚³ãƒ¼ãƒ‰ã‚’ Git ç®¡ç†ã—ã‚„ã™ããªã‚‹ç‚¹
- Clasp ã¯ TypeScript ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ç‚¹
- å¥½ããªã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½¿ã†ã“ã¨ãŒã§ãã‚‹ç‚¹

ã¾ãšã¯ã€Clasp CLI ã‚’å°å…¥ã—ã¾ã™ã€‚

```sh
# Clasp ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ npm install -g @google/clasp

# ç¢ºèª
$ clasp --version

# ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãã®ã§ã€Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¾ã™
$ clasp login
```

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

Clasp CLI ã‚’ä½¿ã£ã¦ä½œæˆã—ã¾ã™ã€‚`--type` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦åŒæ™‚ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç´ã¥ãã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚‚ä½œæˆã—ã¾ã™ã€‚

```sh
$ clasp create --title "kindle-booklog-sync" \
    --type sheets \
    --rootDir ./src
```

ãƒ­ãƒ¼ã‚«ãƒ«ã« `appsscript.json` ã‚’å«ã‚€é››å½¢ãŒä½œæˆã•ã‚Œã¦ã„ã‚Œã° OK ã§ã™ã€‚

## GAS ã§ Gmail ã‚’æ¤œç´¢ã™ã‚‹

å®Ÿéš›ã« `./src` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« TS ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦æ›¸ã„ã¦ã„ãè¨³ã§ã™ãŒ Google ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ‰±ã†å ´åˆã¯ GAS ã‚’ä½¿ã†ã¨ä¸‹è¨˜ã®ã‚ˆã†ã«éå¸¸ã«ç°¡å˜ã§ã™ã€‚

```typescript
interface GmailApp {
  search(query: string): GmailThread[]
}

const searchEmail = (): GmailThread[] => {
  return GmailApp.search("from:digital-no-reply@amazon.co.jp in:inbox")
}
```

ã¡ãªã¿ã«ã€ãƒ¡ãƒ¼ãƒ«ã®æ¤œç´¢ã«ã¯å®Ÿéš›ã« Kindle ã§æ›¸ç±ã‚’è³¼å…¥ã—ãŸéš›ã«é€ã‚‰ã‚Œã¦ãã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ from ã«æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

## ãƒ–ã‚¯ãƒ­ã‚°ã« Asin ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦æ›¸ç±ã‚’ç™»éŒ²ã™ã‚‹

ãƒ­ã‚°ã‚¤ãƒ³ã®å‡¦ç†ãªã©ã¯å¿…è¦ã§ã™ãŒã€ä»Šå›ã¯çœç•¥ã—ã¦å®Ÿéš›ã«ç™»éŒ²ã™ã‚‹å‡¦ç†ã ã‘ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸã€‚

`UrlFetchApp.fetch()` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ HTTP ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è¿”ã‚Šå€¤ã¯ `HTTPResponse` ã§ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’å–å¾—ã§ãã¾ã™ã€‚

```typescript
const uploadBook = (cookies: string[], asinList: string[]): HTTPResponse => {
  const url = 'https://booklog.jp/input'

  return UrlFetchApp.fetch(url, {
    method: 'post',
    headers: {
      Cookie: cookies.join(';'),
      Referer: url
    },
    payload: {
      isbns: asinList.join("\n"),
      category_id: 0, // ãªã—
      status: 4 // ç©èª­
    }
  })
}
```

`category_id` ã¯ãƒ–ã‚¯ãƒ­ã‚°ä¸Šã§ã®ã‚«ãƒ†ã‚´ãƒªã§ã™ã€‚äº‹å‰ã«ä½œã£ã¦ãŠã„ã¦ãã® ID ã‚’æŒ‡å®šã—ã¦ã‚‚è‰¯ã„ã§ã™ã—ã€åƒ•ã¿ãŸã„ã« 0 ã¨ã™ã‚‹ã¨ `æœªé¸æŠ` ã«ãªã‚Šã¾ã™ã€‚

`status` ã¯èª­æ›¸çŠ¶æ³ã§ã™ã€‚`0: æœªè¨­å®š`, `1: èª­ã¿ãŸã„`, `2: ã„ã¾èª­ã‚“ã§ã‚‹`, `3: èª­ã¿çµ‚ã‚ã£ãŸ` ã¨ãªã£ã¦ã„ã‚‹ã®ã§ã€ã¨ã‚Šã‚ãˆãšè³¼å…¥ã—ãŸã°ã‹ã‚Šãªã®ã§ `4: ç©èª­` ã«ã—ã¾ã—ãŸã€‚


## çµæœã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€

ä¸Šè¨˜ã® HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ®‹ã—ã¦ãŠãã¾ã™ã€‚
`getSheetByName()` ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã«ã¯ã‚·ãƒ¼ãƒˆã®åå‰ã‚’æŒ‡å®šã—ã¾ã—ãŸã€‚äº‹å‰ã«å¥½ããªåå‰ã«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```typescript
const log = (asin: string, text: string): void => {
  SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('log') // ã‚·ãƒ¼ãƒˆåã‚’è¨˜è¼‰
    .appendRow([new Date(), asin, text])
}
```
å®Ÿè¡Œã—ãŸå¾Œã§è¦‹ã¦ã¿ã‚‹ã¨ã¡ã‚ƒã‚“ã¨ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/1dd1adf71e56f7a985330067.png)

## ãƒ–ã‚¯ãƒ­ã‚°ã‚’ç¢ºèª

ãƒ–ã‚¯ãƒ­ã‚°ã®æ–¹ã‚‚ç¢ºèªã—ã¦ã¿ã‚‹ã¨ç™»éŒ²ãŒã§ãã¦ã„ã¾ã—ãŸã€‚è‰¯ã•ã’ã§ã™ã­ã€‚

![](https://storage.googleapis.com/zenn-user-upload/5cdd7a36fa528a0c70908469.png)

## GitHub Actions ã§ãƒ‡ãƒ—ãƒ­ã‚¤

ä»Šå›ã¯ `git tag` ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚é•·ããªã£ã¦ã—ã¾ã£ãŸã®ã§ã‚³ãƒ¼ãƒ‰ã®æŠ˜ã‚ŠãŸãŸã‚“ã§ãŠãã¾ã™ã€‚

`env` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°ã¯äº‹å‰ã« GitHub ä¸Šã«ç™»éŒ²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
`ãƒªãƒã‚¸ãƒˆãƒª TOP` > `Settings` > `Secrets` ã§ç™»éŒ²ç”»é¢ã«è¡Œãã“ã¨ãŒã§ãã¾ã™ã€‚

:::details .github/workflows/deploy.yml

```yml
name: Deployment

on:
  push:
    tags:
      - "v*"

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['14.16.x']

    env:
      CLASP_ACCESS_TOKEN: ${{ secrets.CLASP_ACCESS_TOKEN }}
      CLASP_CLIENT_ID: ${{ secrets.CLASP_CLIENT_ID }}
      CLASP_CLIENT_SECRET: ${{ secrets.CLASP_CLIENT_SECRET }}
      CLASP_EXPIRY_DATE: ${{ secrets.CLASP_EXPIRY_DATE }}
      CLASP_ID_TOKEN: ${{ secrets.CLASP_ID_TOKEN }}
      CLASP_REFRESH_TOKEN: ${{ secrets.CLASP_REFRESH_TOKEN }}
      CLASP_SCRIPT_ID: ${{ secrets.CLASP_SCRIPT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'

      - name: Set env
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - name: Cache node modules
        uses: actions/cache@v2
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-

      - name: Create authentication file
        run: |
          echo $(cat <<-EOS
          {
            "token": {
              "access_token": "${CLASP_ACCESS_TOKEN}",
              "scope": "https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/script.webapp.deploy openid https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/service.management https://www.googleapis.com/auth/logging.read https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/script.deployments https://www.googleapis.com/auth/drive.metadata.readonly",
              "token_type": "Bearer",
              "id_token": "${CLASP_ID_TOKEN}",
              "expiry_date": ${CLASP_EXPIRY_DATE},
              "refresh_token": "${CLASP_REFRESH_TOKEN}"
            },
            "oauth2ClientSettings": {
              "clientId": "${CLASP_CLIENT_ID}",
              "clientSecret": "${CLASP_CLIENT_SECRET}",
              "redirectUri": "http://localhost"
            },
            "isLocalCreds": false
          }
          EOS
          ) > ~/.clasprc.json
      - name: Create clasp application file
        run: |
          echo $(cat <<-EOS
          {
            "scriptId": "${CLASP_SCRIPT_ID}",
            "rootDir": "./src",
            "fileExtension": "ts"
          }
          EOS
          ) > ./.clasp.json
      - name: Get version
        id: version
        run: echo ::set-output name=VERSION::${GITHUB_REF#refs/tags/}

      - name: Deploy to GAS
        run: npx @google/clasp push --force

      - name: Add version
        run: npx @google/clasp version ${{ steps.version.outputs.VERSION }}
```

:::

GitHub Actions ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸã‚‰ `clasp open` ã¨å®Ÿè¡Œã—ã¦å®Œäº†ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

## ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š

GAS ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã§ããŸã¨ã“ã‚ã§å®šæœŸå®Ÿè¡Œã•ã›ã‚‹ãŸã‚ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚å·¦å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¸­ã‹ã‚‰ãƒˆãƒªã‚¬ãƒ¼ã‚’é¸æŠè‚¢ã€ã€Œãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½åŠ ã€ã§è¨­å®šã§ãã¾ã™ã€‚åƒ•ã¯æ¯æ—¥å®Ÿè¡Œã«ã—ã¦ãŠãã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/0bcf9de3d7156a7527b65664.png)

# ã¾ã¨ã‚

ã“ã‚Œã¾ã§ GAS ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¨ãƒ‡ã‚£ã‚¿ã§æ›¸ãã“ã¨ãŒå¤šã‹ã£ãŸã®ã§ã€ã„ã¤ã‚‚ä½¿ã£ã¦ã„ã‚‹ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½¿ãˆã‚‹ã®ã¯ã‚¨ãƒ‡ã‚£ã‚¿ã®æ©Ÿèƒ½ã‚’ãã®ã¾ã¾ä½¿ãˆã¦åŠ¹ç‡ãŒã„ã„ã—ã€ã‚¹ãƒˆãƒ¬ã‚¹ãªãå®Ÿè£…ã§ãã¾ã—ãŸã€‚ã¾ãŸã€ãªã‚“ã¨ã„ã£ã¦ã‚‚ TypeScript ã§å‹å®šç¾©ãŒã§ãã‚‹ç‚¹ã¯éå¸¸ã«ã„ã„ã§ã™ã­ã€‚

ã¾ãŸã€GitHub ä¸Šã§ç®¡ç†ã§ãã‚‹ç‚¹ã¯ã‹ãªã‚Šå¤§ãã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚ï¼ˆä»Šå›ã®å†…å®¹ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã§ã™ãŒï¼‰ãƒãƒ¼ãƒ ã§é–‹ç™ºã™ã‚‹éš›ã«ã¯å¿…é ˆã«ãªã£ã¦ãã‚‹ã®ã¨ã€GitHub Actions ã‚’ä½¿ãˆã‚‹ã¨ã„ã†ã®ãŒå¤§ããªãƒ¡ãƒªãƒƒãƒˆã§ã™ã€‚

èª­ã‚“ã§ãã ã•ã£ãŸæ–¹ã§ã€è‡ªåˆ†ã¯ã“ã‚“ãªèª­æ›¸ç®¡ç†ã—ã¦ã„ã‚‹ã‚ˆã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Œã°ãœã²æ•™ãˆã¦ãã ã•ã„ï¼

# å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸã‚µã‚¤ãƒˆ

https://tateren.hateblo.jp/entry/2016/10/03/025425
https://rela1470.hatenablog.jp/entry/2018/02/05/205140
https://panda-program.com/posts/clasp-typescript
https://dev.classmethod.jp/articles/typescript-clasp-github-actions/

[^1]:[ãƒ–ã‚¯ãƒ­ã‚° \- webæœ¬æ£šã‚µãƒ¼ãƒ“ã‚¹](https://booklog.jp/input)
